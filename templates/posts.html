{% extends 'base.html' %}
{% block title %}{{ feed_type|capitalize }} Posts - HiveBuzz{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ feed_type|capitalize }} Posts</h1>
        <div class="refresh-controls">
            <button id="refreshBtn" class="btn btn-outline-primary">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Feed filter tabs -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link {{ 'active' if feed_type == 'trending' else '' }}"
               href="{{ url_for('posts', feed='trending', tag=tag) }}">Trending</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {{ 'active' if feed_type == 'hot' else '' }}"
               href="{{ url_for('posts', feed='hot', tag=tag) }}">Hot</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {{ 'active' if feed_type == 'new' else '' }}"
               href="{{ url_for('posts', feed='new', tag=tag) }}">New</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {{ 'active' if feed_type == 'promoted' else '' }}"
               href="{{ url_for('posts', feed='promoted', tag=tag) }}">Promoted</a>
        </li>
        {% if is_logged_in %}
        <li class="nav-item">
            <a class="nav-link {{ 'active' if feed_type == 'followed' else '' }}"
               href="{{ url_for('posts', feed='followed', tag=tag) }}">Following</a>
        </li>
        {% endif %}

        <!-- Tag filter if active -->
        {% if tag %}
        <li class="nav-item ms-auto">
            <span class="nav-link active">
                #{{ tag }}
                <a href="{{ url_for('posts', feed=feed_type) }}" class="ms-2 text-decoration-none">
                    <i class="bi bi-x-circle"></i>
                </a>
            </span>
        </li>
        {% endif %}
    </ul>

    <!-- Full page loading indicator for when posts are being initialized -->
    {% if is_feed_initializing %}
    <div id="feed-initializing" class="feed-loading-container">
        <div class="feed-loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4>Loading {{ feed_type|capitalize }} Posts...</h4>
            <p class="text-muted">This will only take a moment</p>
        </div>
    </div>
    {% endif %}

    <!-- Cache refreshing notification -->
    {% if cache_refreshing and not is_feed_initializing %}
    <div class="alert alert-info alert-dismissible fade show mb-4" role="alert" id="cache-initializing">
        <div class="d-flex align-items-center">
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            <div>Loading additional blockchain data in background... <small>(Posts will update automatically)</small></div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Demo data notice -->
    {% for post in posts %}
        {% if post.is_demo and loop.first %}
        <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            Showing demo content because we couldn't retrieve posts from the Hive blockchain.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
    {% endfor %}

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="posts-container"
         {% if is_feed_initializing %}style="opacity: 0.3;"{% endif %}>
        {% if posts %}
            {% for post in posts %}
                <div class="col">
                    <div class="card h-100 post-card">
                        {% if post.image %}
                            <a href="{{ url_for('view_post', author=post.author, permlink=post.permlink) }}" class="post-image-link">
                                <img src="{{ post.image }}" class="card-img-top post-image" alt="Post image"
                                     onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/placeholder.jpg') }}';">
                            </a>
                        {% else %}
                            <div class="card-img-placeholder">
                                <i class="bi bi-card-text"></i>
                            </div>
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title post-title">
                                <a href="{{ url_for('view_post', author=post.author, permlink=post.permlink) }}" class="text-decoration-none">
                                    {{ post.title|truncate(60) }}
                                </a>
                            </h5>
                            <div class="post-meta mb-2">
                                <div class="d-flex align-items-center">
                                    <a href="{{ url_for('profile', username=post.author) }}" class="author-link d-flex align-items-center text-decoration-none">
                                        <img src="https://images.hive.blog/u/{{ post.author }}/avatar" alt="{{ post.author }}"
                                             class="avatar-xs me-2" width="24" height="24">
                                        @{{ post.author }}
                                    </a>
                                    <span class="ms-auto text-muted small">
                                        {% if post.created is string %}
                                            {{ post.created[:10] }}
                                        {% else %}
                                            {{ post.created.strftime('%Y-%m-%d') if post.created else 'Unknown date' }}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            <div class="post-excerpt markdown-preview">
                                {{ post.body|markdown|striptags|truncate(160) }}
                            </div>

                            <!-- Tags -->
                            {% if post.tags %}
                            <div class="post-tags mb-2">
                                {% for tag in post.tags[:3] %}
                                <a href="{{ url_for('posts', feed=feed_type, tag=tag) }}" class="badge bg-light text-dark me-1">
                                    #{{ tag }}
                                </a>
                                {% endfor %}
                                {% if post.tags|length > 3 %}
                                <span class="badge bg-light text-dark">+{{ post.tags|length - 3 }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="post-stats">
                                    <!-- Vote button for logged in users only and not demo posts -->
                                    {% if is_logged_in and not post.is_demo %}
                                    <button class="btn btn-sm btn-outline-primary vote-btn me-2"
                                            data-author="{{ post.author }}"
                                            data-permlink="{{ post.permlink }}"
                                            {% if post.author == username %}disabled{% endif %}>
                                        <i class="bi bi-hand-thumbs-up"></i>
                                        <span class="vote-count">{{ post.vote_count }}</span>
                                    </button>
                                    {% else %}
                                    <span><i class="bi bi-heart"></i> {{ post.vote_count }}</span>
                                    {% endif %}

                                    <!-- Comment count -->
                                    <a href="{{ url_for('view_post', author=post.author, permlink=post.permlink) }}"
                                       class="btn btn-sm btn-outline-secondary ms-2"
                                       title="View comments">
                                        <i class="bi bi-chat-dots"></i>
                                        <span>{{ post.comment_count }}</span>
                                    </a>
                                </div>
                                <div class="post-payout">
                                    <span class="text-success">{{ post.payout }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i> No posts found. Please try again later.
                </div>
            </div>
        {% endif %}
    </div>

    <div class="text-center mt-4">
        <div id="loading-posts" class="d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading more posts...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .post-card {
        transition: transform 0.2s, box-shadow 0.2s;
        overflow: hidden;
    }

    .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .card-img-placeholder {
        height: 160px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        color: #adb5bd;
        font-size: 2.5rem;
    }

    body.dark-mode .card-img-placeholder {
        background-color: #343a40;
        color: #6c757d;
    }

    .post-image {
        height: 160px;
        object-fit: cover;
        width: 100%;
    }

    .post-title {
        font-size: 1.1rem;
        line-height: 1.4;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .post-excerpt {
        color: #6c757d;
        font-size: 0.9rem;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.5;
        margin-bottom: 1rem;
    }

    body.dark-mode .post-excerpt {
        color: #adb5bd;
    }

    .author-link {
        color: var(--accent-primary);
    }

    .post-image-link {
        display: block;
        overflow: hidden;
    }

    .post-image-link img {
        transition: transform 0.3s;
    }

    .post-image-link:hover img {
        transform: scale(1.05);
    }

    .nav-tabs .nav-link.active {
        color: var(--accent-primary);
        border-color: var(--accent-primary) var(--accent-primary) #fff;
    }

    body.dark-mode .nav-tabs .nav-link.active {
        color: var(--accent-light);
        border-color: var(--accent-primary) var(--accent-primary) #343a40;
        background-color: #343a40;
    }

    .post-stats .vote-btn.active {
        background-color: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
    }

    /* Add new styles for feed loading container */
    .feed-loading-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
    }

    .feed-loading-content {
        text-align: center;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    body.dark-mode .feed-loading-content {
        background-color: rgba(33, 37, 41, 0.9);
    }

    .feed-loading-container .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    /* Markdown preview styling */
    .markdown-preview {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    }

    .markdown-preview h1, .markdown-preview h2, .markdown-preview h3,
    .markdown-preview h4, .markdown-preview h5, .markdown-preview h6 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0.25rem 0;
    }

    .markdown-preview p {
        margin-bottom: 0.5rem;
    }

    .markdown-preview img {
        max-width: 100%;
        height: auto;
    }

    .markdown-preview code {
        background-color: rgba(0, 0, 0, 0.05);
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.85em;
    }

    body.dark-mode .markdown-preview code {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .markdown-preview blockquote {
        border-left: 3px solid var(--accent-primary);
        padding-left: 0.5rem;
        color: #6c757d;
        margin: 0.5rem 0;
    }

    body.dark-mode .markdown-preview blockquote {
        color: #adb5bd;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/hive-keychain.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add data attributes for the posts page to use in the JS
        document.body.dataset.feedType = "{{ feed_type }}";
        document.body.dataset.tag = "{{ tag or '' }}";

        // Check if the feed is still initializing
        const isInitializing = {{ 'true' if is_feed_initializing else 'false' }};
        const postsContainer = document.getElementById('posts-container');

        // If the feed is initializing, poll for status and reload when ready
        if (isInitializing) {
            const feedInitLoader = document.getElementById('feed-initializing');

            // Function to check feed status
            function checkFeedStatus() {
                fetch(`/api/check-feed-status?feed={{ feed_type }}&tag={{ tag or '' }}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.ready) {
                            // Feed is ready, reload the page
                            window.location.reload();
                        } else {
                            // Feed is still loading, check again in 1.5 seconds
                            setTimeout(checkFeedStatus, 1500);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking feed status:', error);
                        // On error, retry after 3 seconds
                        setTimeout(checkFeedStatus, 3000);
                    });
            }

            // Start checking feed status
            setTimeout(checkFeedStatus, 1000);  // Wait 1 second before first check
        }

        // Check for cache initialization status
        const cacheInitializing = {{ 'true' if cache_refreshing else 'false' }};
        const isCacheFresh = {{ 'true' if is_cache_fresh else 'false' }};

        // Rest of the code handling cache status, refresh button, and vote functionality
        // ...existing code...

        // Refresh button functionality
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                // Show loading spinner on the button
                const originalHtml = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span> Loading...';
                refreshBtn.disabled = true;

                // Reload the page
                window.location.reload();
            });
        }

        // Vote button functionality (only for logged-in users)
        {% if is_logged_in %}
        const voteBtns = document.querySelectorAll('.vote-btn');
        voteBtns.forEach(btn => {
            btn.addEventListener('click', async function() {
                const author = this.getAttribute('data-author');
                const permlink = this.getAttribute('data-permlink');
                const username = '{{ username }}';

                // Check if Hive Keychain is available
                if (!HiveKeychainHelper || !HiveKeychainHelper.isKeychainInstalled()) {
                    alert('Hive Keychain is required to vote. Please install the browser extension first.');
                    return;
                }

                try {
                    // Default to 100% upvote
                    const weight = 10000;

                    // Show loading state
                    btn.disabled = true;
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';

                    // Request vote via Hive Keychain
                    const response = await HiveKeychainHelper.requestVote(
                        username,
                        author,
                        permlink,
                        weight
                    );

                    if (response.success) {
                        // Update vote count and style
                        const countElement = btn.querySelector('.vote-count');
                        if (countElement) {
                            countElement.textContent = parseInt(countElement.textContent || '0') + 1;
                        }

                        btn.classList.add('active');
                        btn.innerHTML = originalHtml;

                        // Show success toast
                        showToast('Vote successful!', 'success');
                    } else {
                        // Restore button state
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;

                        // Show error message
                        showToast('Vote failed: ' + (response.message || 'Unknown error'), 'danger');
                    }
                } catch (error) {
                    // Restore button state
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;

                    showToast('Error: ' + error, 'danger');
                }
            });
        });
        {% endif %}

        // Helper function to show toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.style.zIndex = '11';
            toast.innerHTML = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);

            // Initialize and show the toast
            const toastEl = new bootstrap.Toast(toast.querySelector('.toast'));
            toastEl.show();

            // Remove toast element after it hides
            toast.addEventListener('hidden.bs.toast', function() {
                document.body.removeChild(toast);
            });
        }
    });
</script>
{% endblock %}
