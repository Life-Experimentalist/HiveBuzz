{% extends 'base.html' %}
{% block title %}Latest Posts - HiveBuzz{% endblock %}

{% block content %}
<div class="container">
    <div class="feed-container">
        <h1 class="mb-2">Latest Posts</h1>
        <p class="subtitle mb-4">Discover what's happening on the Hive blockchain</p>

        <div class="filter-options mb-4">
            <div class="row align-items-center">
                <div class="col-md-6 mb-3 mb-md-0">
                    <div class="input-group">
                        <input type="text" class="form-control" id="search-posts" placeholder="Search posts...">
                        <button class="btn btn-outline-secondary" type="button" id="search-button">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-6 d-flex justify-content-md-end">
                    <select class="form-select me-2" style="max-width: 180px;" id="sort-posts">
                        <option value="latest">Latest</option>
                        <option value="trending">Trending</option>
                        <option value="votes">Most Upvoted</option>
                        <option value="payout">Highest Payout</option>
                    </select>
                    <select class="form-select" style="max-width: 180px;" id="filter-tags">
                        <option value="">All Tags</option>
                        <option value="hive">hive</option>
                        <option value="blockchain">blockchain</option>
                        <option value="crypto">crypto</option>
                        <option value="defi">defi</option>
                        <option value="technology">technology</option>
                    </select>
                </div>
            </div>
        </div>

        {% if posts %}
        <div class="feed-list">
            {% for post in posts %}
            <div class="feed-item">
                <a href="{{ url_for('view_post', author=post.author, permlink=post.permlink) }}" class="post-title-link">
                    <h3 class="post-title">{{ post.title }}</h3>
                </a>
                <div class="post-meta">
                    <a href="{{ url_for('profile', username=post.author) }}" class="post-author">@{{ post.author }}</a>
                    <span class="post-date">{{ post.created }}</span>
                    {% if post.payout %}<span class="post-payout">${{ post.payout }}</span>{% endif %}
                    {% if post.vote_count %}<span class="post-votes">{{ post.vote_count }} votes</span>{% endif %}
                </div>
                <div class="post-content">
                    {% if post.body|length > 200 %}
                        {{ post.body[:200]|safe }}...
                        <a href="{{ url_for('view_post', author=post.author, permlink=post.permlink) }}" class="read-more">Read more</a>
                    {% else %}
                        {{ post.body|safe }}
                    {% endif %}
                </div>
                <div class="post-actions">
                    <button class="upvote-btn" data-author="{{ post.author }}" data-permlink="{{ post.permlink }}">
                        üëç Upvote
                    </button>
                    <a href="{{ url_for('view_post', author=post.author, permlink=post.permlink) }}" class="comment-btn">
                        üí¨ {{ post.comment_count|default(0) }} Comments
                    </a>
                    <button class="share-btn" data-author="{{ post.author }}" data-permlink="{{ post.permlink }}" data-title="{{ post.title }}">
                        üîó Share
                    </button>
                </div>
                {% if post.tags %}
                <div class="post-tags">
                    {% for tag in post.tags %}
                    <span class="tag">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <nav class="d-flex justify-content-center mt-4">
            <ul class="pagination">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>
            </ul>
        </nav>
        {% else %}
        <div class="empty-state text-center my-5">
            <div class="empty-state-icon mb-4">
                <i class="bi bi-file-earmark-text" style="font-size: 3rem;"></i>
            </div>
            <h3>No posts found</h3>
            <p class="text-muted">There are currently no posts to display.</p>
            {% if session.get('username') %}
            <a href="{{ url_for('create_post') }}" class="btn btn-primary mt-3">Create a Post</a>
            {% else %}
            <a href="{{ url_for('login') }}" class="btn btn-primary mt-3">Login to Post</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Upvote functionality
        const upvoteBtns = document.querySelectorAll(".upvote-btn");
        upvoteBtns.forEach(btn => {
            btn.addEventListener("click", function() {
                const author = this.getAttribute("data-author");
                const permlink = this.getAttribute("data-permlink");

                if (window.hive_keychain) {
                    const username = "{{ session.get('username', '') }}";
                    if (!username) {
                        alert("Please log in to upvote posts.");
                        return;
                    }

                    // In a real app, this would call the Hive blockchain
                    alert(`In a real implementation, this would upvote @${author}/${permlink} on the Hive blockchain.`);
                } else {
                    alert("Hive Keychain extension is required for upvoting.");
                }
            });
        });

        // Share functionality
        const shareBtns = document.querySelectorAll(".share-btn");
        shareBtns.forEach(btn => {
            btn.addEventListener("click", function() {
                const author = this.getAttribute("data-author");
                const permlink = this.getAttribute("data-permlink");
                const title = this.getAttribute("data-title");

                // Create share URL for social media
                const shareUrl = `${window.location.origin}/post/${author}/${permlink}`;
                const shareText = `Check out this post on HiveBuzz: ${title}`;

                try {
                    if (navigator.share) {
                        navigator.share({
                            title: title,
                            text: shareText,
                            url: shareUrl,
                        });
                    } else {
                        // Fallback to clipboard copy
                        navigator.clipboard.writeText(shareUrl).then(() => {
                            alert("Link copied to clipboard!");
                        });
                    }
                } catch (err) {
                    console.error("Error sharing:", err);
                    // Fallback to clipboard copy
                    prompt("Copy this link to share:", shareUrl);
                }
            });
        });

        // Filter & search functionality
        const searchInput = document.getElementById("search-posts");
        const searchButton = document.getElementById("search-button");
        const sortSelect = document.getElementById("sort-posts");
        const filterTagsSelect = document.getElementById("filter-tags");

        if (searchButton) {
            searchButton.addEventListener("click", function() {
                applyFilters();
            });
        }

        if (sortSelect) {
            sortSelect.addEventListener("change", function() {
                applyFilters();
            });
        }

        if (filterTagsSelect) {
            filterTagsSelect.addEventListener("change", function() {
                applyFilters();
            });
        }

        function applyFilters() {
            const searchQuery = searchInput ? searchInput.value.trim() : "";
            const sortBy = sortSelect ? sortSelect.value : "latest";
            const tagFilter = filterTagsSelect ? filterTagsSelect.value : "";

            // In a real app, this would fetch filtered posts from the server
            console.log(`Filtering posts: search="${searchQuery}", sort="${sortBy}", tag="${tagFilter}"`);

            // For demo purposes, we'll just add a small visual feedback
            const feedItems = document.querySelectorAll(".feed-item");
            if (feedItems.length > 0) {
                feedItems.forEach(item => {
                    item.style.opacity = "0.7";
                });

                setTimeout(() => {
                    feedItems.forEach(item => {
                        item.style.opacity = "1";
                    });
                }, 500);
            }
        }
    });
</script>
{% endblock %}

{% block styles %}
<style>
    .feed-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .subtitle {
        color: #6c757d;
    }

    .empty-state {
        padding: 3rem 0;
    }

    .empty-state-icon {
        color: #ccc;
    }
</style>
{% endblock %}
